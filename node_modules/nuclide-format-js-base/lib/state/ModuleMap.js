var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

var _templateObject = _taggedTemplateLiteral(['import type {_} from \'_\''], ['import type {_} from \'_\'']),
    _templateObject2 = _taggedTemplateLiteral(['import type _ from \'_\''], ['import type _ from \'_\'']);

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

function _taggedTemplateLiteral(strings, raw) { return Object.freeze(Object.defineProperties(strings, { raw: { value: Object.freeze(raw) } })); }

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

'use babel';

var ModuleMapUtils = require('../utils/ModuleMapUtils');
var Options = require('../options/Options');

var jscs = require('jscodeshift');
var oneLineObjectPattern = require('../utils/oneLineObjectPattern');

var statement = jscs.template.statement;

var ModuleMap = (function () {
  function ModuleMap(options) {
    _classCallCheck(this, ModuleMap);

    Options.validateModuleMapOptions(options);

    // Note: If someone maintains a reference to the structure within options
    // they could mutate the ModuleMap's behavior. We could make shallow copies
    // here but are opting not to for performance.
    this._builtIns = options.builtIns;
    this._builtInTypes = options.builtInTypes;
    this._aliases = options.aliases;
    this._aliasesToRelativize = options.aliasesToRelativize;

    // TODO: Use let for proper scoping.
    var id = undefined;
    var ids = undefined;
    var filePath = undefined;
    var set = undefined;

    this._defaults = new Map();
    for (filePath of options.paths) {
      ids = ModuleMapUtils.getIdentifiersFromPath(filePath);
      var literal = ModuleMapUtils.getLiteralFromPath(filePath);
      for (id of ids) {
        set = this._defaults.get(id);
        if (!set) {
          set = new Set();
          this._defaults.set(id, set);
        }
        set.add(literal);
      }
    }

    this._defaultsToRelativize = new Map();
    for (filePath of options.pathsToRelativize) {
      ids = ModuleMapUtils.getIdentifiersFromPath(filePath);
      for (id of ids) {
        set = this._defaultsToRelativize.get(id);
        if (!set) {
          set = new Set();
          this._defaultsToRelativize.set(id, set);
        }
        set.add(filePath);
      }
    }
  }

  /**
   * Gets a single require, this isn't great for when you want to destructure
   * multiple things in a single statement.
   *
   * TODO: add a getRequires() that consolidates automatically, or add a
   * specific consolidate step as part of the transform.
   */

  _createClass(ModuleMap, [{
    key: 'getRequire',
    value: function getRequire(id, options) {
      Options.validateRequireOptions(options);

      // Don't import built ins.
      if (!options.typeImport) {
        if (this._builtIns.has(id)) {
          return null;
        }
      } else {
        if (this._builtInTypes.has(id)) {
          return null;
        }
      }

      // TODO: Use let for proper scoping.
      var literal = undefined;
      var tmp = undefined;

      if (this._aliases.has(id)) {
        literal = this._aliases.get(id);
      } else if (options.sourcePath && this._aliasesToRelativize.has(id)) {
        literal = ModuleMapUtils.relativizeForRequire(options.sourcePath, this._aliasesToRelativize.get(id));
      } else if (this._defaults.has(id) && this._defaults.get(id).size === 1) {
        // TODO: What's the best way to get the single thing out of a one element
        // Set?
        for (tmp of this._defaults.get(id)) {
          literal = tmp;
          break;
        }
      } else if (options.sourcePath && this._defaultsToRelativize.has(id) && this._defaultsToRelativize.get(id).size === 1) {
        var nonNullSourcePath = options.sourcePath;
        // TODO: What's the best way to get the single thing out of a one element
        // Set?
        for (var filePath of this._defaultsToRelativize.get(id)) {
          literal = ModuleMapUtils.relativizeForRequire(nonNullSourcePath, filePath);
          break;
        }
      } else if (options.jsxIdentifier) {
        // TODO: Make this configurable so that the suffix for JSX can be changed.
        literal = id + '.react';
      } else {
        // TODO: Make this configurable so that it's possible to only add known
        // requires and ignore unknown modules.
        literal = id;
      }

      // Create common nodes for printing.
      var idNode = jscs.identifier(id);
      var literalNode = jscs.literal(literal);

      // TODO: Support exports and destructuring.
      var destructure = false;

      if (destructure && options.typeImport) {
        // import type {foo} from 'foo';
        tmp = statement(_templateObject);
        tmp.specifiers[0].imported = idNode;
        tmp.specifiers[0].local = idNode;
        tmp.source = literalNode;
        return tmp;
      } else if (!destructure && options.typeImport) {
        // import type foo from 'foo';
        tmp = statement(_templateObject2);
        tmp.specifiers[0].id = idNode;
        tmp.specifiers[0].local = idNode;
        tmp.source = literalNode;
        return tmp;
      } else if (destructure && !options.typeImport) {
        // var {foo} = require('foo');
        var property = jscs.property('init', idNode, idNode);
        property.shorthand = true;
        return jscs.variableDeclaration('const', [jscs.variableDeclarator(oneLineObjectPattern(jscs.objectPattern([property])), jscs.callExpression(jscs.identifier('require'), [literalNode]))]);
      } else if (!destructure && !options.typeImport) {
        // var foo = require('foo');
        return jscs.variableDeclaration('const', [jscs.variableDeclarator(idNode, jscs.callExpression(jscs.identifier('require'), [literalNode]))]);
      }

      // Can't handle this type of require yet.
      return null;
    }
  }, {
    key: 'getBuiltIns',
    value: function getBuiltIns() {
      return this._builtIns;
    }
  }, {
    key: 'getBuiltInTypes',
    value: function getBuiltInTypes() {
      return this._builtInTypes;
    }
  }]);

  return ModuleMap;
})();

module.exports = ModuleMap;

// Note: These fields are ordered by precendence.

/**
 * Identifiers that should be ignored when not a type.
 */

/**
 * Identifiers that should be ignored when they are a type.
 */

/**
 * Identifiers that have an exact alias to use.
 */

/**
 * Identifiers that have an exact path to use.
 */

/**
 * Identifiers that might correspond to the default export of a particular
 * literal.
 */

/**
 * Identifiers that might correspond to the default export of a particular
 * absolute path.
 */
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWZvcm1hdC1qcy1iYXNlL2xpYi9zdGF0ZS9Nb2R1bGVNYXAuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxXQUFXLENBQUM7O0FBZVosSUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQUM7QUFDMUQsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7O0FBRTlDLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUNwQyxJQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQywrQkFBK0IsQ0FBQyxDQUFDOztJQUUvRCxTQUFTLEdBQUksSUFBSSxDQUFDLFFBQVEsQ0FBMUIsU0FBUzs7SUFFVixTQUFTO0FBOEJGLFdBOUJQLFNBQVMsQ0E4QkQsT0FBeUIsRUFBRTswQkE5Qm5DLFNBQVM7O0FBK0JYLFdBQU8sQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLENBQUMsQ0FBQzs7Ozs7QUFLMUMsUUFBSSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDO0FBQ2xDLFFBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztBQUMxQyxRQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUM7QUFDaEMsUUFBSSxDQUFDLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQzs7O0FBR3hELFFBQUksRUFBRSxZQUFBLENBQUM7QUFDUCxRQUFJLEdBQUcsWUFBQSxDQUFDO0FBQ1IsUUFBSSxRQUFRLFlBQUEsQ0FBQztBQUNiLFFBQUksR0FBRyxZQUFBLENBQUM7O0FBRVIsUUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQzNCLFNBQUssUUFB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LDJCQUFvQjtBQUNqQyxhQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7S0FDM0I7OztTQXhNRyxTQUFTOzs7QUEyTWYsTUFBTSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtZm9ybWF0LWpzLWJhc2UvbGliL3N0YXRlL01vZHVsZU1hcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtBYnNvbHV0ZVBhdGgsIElkZW50aWZpZXIsIExpdGVyYWx9IGZyb20gJy4uL3R5cGVzL2NvbW1vbic7XG5pbXBvcnQgdHlwZSB7TW9kdWxlTWFwT3B0aW9uc30gZnJvbSAnLi4vb3B0aW9ucy9Nb2R1bGVNYXBPcHRpb25zJztcbmltcG9ydCB0eXBlIHtSZXF1aXJlT3B0aW9uc30gZnJvbSAnLi4vb3B0aW9ucy9SZXF1aXJlT3B0aW9ucyc7XG5cbmNvbnN0IE1vZHVsZU1hcFV0aWxzID0gcmVxdWlyZSgnLi4vdXRpbHMvTW9kdWxlTWFwVXRpbHMnKTtcbmNvbnN0IE9wdGlvbnMgPSByZXF1aXJlKCcuLi9vcHRpb25zL09wdGlvbnMnKTtcblxuY29uc3QganNjcyA9IHJlcXVpcmUoJ2pzY29kZXNoaWZ0Jyk7XG5jb25zdCBvbmVMaW5lT2JqZWN0UGF0dGVybiA9IHJlcXVpcmUoJy4uL3V0aWxzL29uZUxpbmVPYmplY3RQYXR0ZXJuJyk7XG5cbmNvbnN0IHtzdGF0ZW1lbnR9ID0ganNjcy50ZW1wbGF0ZTtcblxuY2xhc3MgTW9kdWxlTWFwIHtcbiAgLy8gTm90ZTogVGhlc2UgZmllbGRzIGFyZSBvcmRlcmVkIGJ5IHByZWNlbmRlbmNlLlxuXG4gIC8qKlxuICAgKiBJZGVudGlmaWVycyB0aGF0IHNob3VsZCBiZSBpZ25vcmVkIHdoZW4gbm90IGEgdHlwZS5cbiAgICovXG4gIF9idWlsdEluczogU2V0PElkZW50aWZpZXI+O1xuICAvKipcbiAgICogSWRlbnRpZmllcnMgdGhhdCBzaG91bGQgYmUgaWdub3JlZCB3aGVuIHRoZXkgYXJlIGEgdHlwZS5cbiAgICovXG4gIF9idWlsdEluVHlwZXM6IFNldDxJZGVudGlmaWVyPjtcbiAgLyoqXG4gICAqIElkZW50aWZpZXJzIHRoYXQgaGF2ZSBhbiBleGFjdCBhbGlhcyB0byB1c2UuXG4gICAqL1xuICBfYWxpYXNlczogTWFwPElkZW50aWZpZXIsIExpdGVyYWw+O1xuICAvKipcbiAgICogSWRlbnRpZmllcnMgdGhhdCBoYXZlIGFuIGV4YWN0IHBhdGggdG8gdXNlLlxuICAgKi9cbiAgX2FsaWFzZXNUb1JlbGF0aXZpemU6IE1hcDxJZGVudGlmaWVyLCBBYnNvbHV0ZVBhdGg+O1xuICAvKipcbiAgICogSWRlbnRpZmllcnMgdGhhdCBtaWdodCBjb3JyZXNwb25kIHRvIHRoZSBkZWZhdWx0IGV4cG9ydCBvZiBhIHBhcnRpY3VsYXJcbiAgICogbGl0ZXJhbC5cbiAgICovXG4gIF9kZWZhdWx0czogTWFwPElkZW50aWZpZXIsIFNldDxMaXRlcmFsPj47XG4gIC8qKlxuICAgKiBJZGVudGlmaWVycyB0aGF0IG1pZ2h0IGNvcnJlc3BvbmQgdG8gdGhlIGRlZmF1bHQgZXhwb3J0IG9mIGEgcGFydGljdWxhclxuICAgKiBhYnNvbHV0ZSBwYXRoLlxuICAgKi9cbiAgX2RlZmF1bHRzVG9SZWxhdGl2aXplOiBNYXA8SWRlbnRpZmllciwgU2V0PEFic29sdXRlUGF0aD4+O1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE1vZHVsZU1hcE9wdGlvbnMpIHtcbiAgICBPcHRpb25zLnZhbGlkYXRlTW9kdWxlTWFwT3B0aW9ucyhvcHRpb25zKTtcblxuICAgIC8vIE5vdGU6IElmIHNvbWVvbmUgbWFpbnRhaW5zIGEgcmVmZXJlbmNlIHRvIHRoZSBzdHJ1Y3R1cmUgd2l0aGluIG9wdGlvbnNcbiAgICAvLyB0aGV5IGNvdWxkIG11dGF0ZSB0aGUgTW9kdWxlTWFwJ3MgYmVoYXZpb3IuIFdlIGNvdWxkIG1ha2Ugc2hhbGxvdyBjb3BpZXNcbiAgICAvLyBoZXJlIGJ1dCBhcmUgb3B0aW5nIG5vdCB0byBmb3IgcGVyZm9ybWFuY2UuXG4gICAgdGhpcy5fYnVpbHRJbnMgPSBvcHRpb25zLmJ1aWx0SW5zO1xuICAgIHRoaXMuX2J1aWx0SW5UeXBlcyA9IG9wdGlvbnMuYnVpbHRJblR5cGVzO1xuICAgIHRoaXMuX2FsaWFzZXMgPSBvcHRpb25zLmFsaWFzZXM7XG4gICAgdGhpcy5fYWxpYXNlc1RvUmVsYXRpdml6ZSA9IG9wdGlvbnMuYWxpYXNlc1RvUmVsYXRpdml6ZTtcblxuICAgIC8vIFRPRE86IFVzZSBsZXQgZm9yIHByb3BlciBzY29waW5nLlxuICAgIGxldCBpZDtcbiAgICBsZXQgaWRzO1xuICAgIGxldCBmaWxlUGF0aDtcbiAgICBsZXQgc2V0O1xuXG4gICAgdGhpcy5fZGVmYXVsdHMgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChmaWxlUGF0aCBvZiBvcHRpb25zLnBhdGhzKSB7XG4gICAgICBpZHMgPSBNb2R1bGVNYXBVdGlscy5nZXRJZGVudGlmaWVyc0Zyb21QYXRoKGZpbGVQYXRoKTtcbiAgICAgIGNvbnN0IGxpdGVyYWwgPSBNb2R1bGVNYXBVdGlscy5nZXRMaXRlcmFsRnJvbVBhdGgoZmlsZVBhdGgpO1xuICAgICAgZm9yIChpZCBvZiBpZHMpIHtcbiAgICAgICAgc2V0ID0gdGhpcy5fZGVmYXVsdHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKCFzZXQpIHtcbiAgICAgICAgICBzZXQgPSBuZXcgU2V0KCk7XG4gICAgICAgICAgdGhpcy5fZGVmYXVsdHMuc2V0KGlkLCBzZXQpO1xuICAgICAgICB9XG4gICAgICAgIHNldC5hZGQobGl0ZXJhbCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5fZGVmYXVsdHNUb1JlbGF0aXZpemUgPSBuZXcgTWFwKCk7XG4gICAgZm9yIChmaWxlUGF0aCBvZiBvcHRpb25zLnBhdGhzVG9SZWxhdGl2aXplKSB7XG4gICAgICBpZHMgPSBNb2R1bGVNYXBVdGlscy5nZXRJZGVudGlmaWVyc0Zyb21QYXRoKGZpbGVQYXRoKTtcbiAgICAgIGZvciAoaWQgb2YgaWRzKSB7XG4gICAgICAgIHNldCA9IHRoaXMuX2RlZmF1bHRzVG9SZWxhdGl2aXplLmdldChpZCk7XG4gICAgICAgIGlmICghc2V0KSB7XG4gICAgICAgICAgc2V0ID0gbmV3IFNldCgpO1xuICAgICAgICAgIHRoaXMuX2RlZmF1bHRzVG9SZWxhdGl2aXplLnNldChpZCwgc2V0KTtcbiAgICAgICAgfVxuICAgICAgICBzZXQuYWRkKGZpbGVQYXRoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhIHNpbmdsZSByZXF1aXJlLCB0aGlzIGlzbid0IGdyZWF0IGZvciB3aGVuIHlvdSB3YW50IHRvIGRlc3RydWN0dXJlXG4gICAqIG11bHRpcGxlIHRoaW5ncyBpbiBhIHNpbmdsZSBzdGF0ZW1lbnQuXG4gICAqXG4gICAqIFRPRE86IGFkZCBhIGdldFJlcXVpcmVzKCkgdGhhdCBjb25zb2xpZGF0ZXMgYXV0b21hdGljYWxseSwgb3IgYWRkIGFcbiAgICogc3BlY2lmaWMgY29uc29saWRhdGUgc3RlcCBhcyBwYXJ0IG9mIHRoZSB0cmFuc2Zvcm0uXG4gICAqL1xuICBnZXRSZXF1aXJlKGlkOiBJZGVudGlmaWVyLCBvcHRpb25zOiBSZXF1aXJlT3B0aW9ucyk6ID9Ob2RlIHtcbiAgICBPcHRpb25zLnZhbGlkYXRlUmVxdWlyZU9wdGlvbnMob3B0aW9ucyk7XG5cbiAgICAvLyBEb24ndCBpbXBvcnQgYnVpbHQgaW5zLlxuICAgIGlmICghb3B0aW9ucy50eXBlSW1wb3J0KSB7XG4gICAgICBpZiAodGhpcy5fYnVpbHRJbnMuaGFzKGlkKSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHRoaXMuX2J1aWx0SW5UeXBlcy5oYXMoaWQpKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFRPRE86IFVzZSBsZXQgZm9yIHByb3BlciBzY29waW5nLlxuICAgIGxldCBsaXRlcmFsO1xuICAgIGxldCB0bXA7XG5cbiAgICBpZiAodGhpcy5fYWxpYXNlcy5oYXMoaWQpKSB7XG4gICAgICBsaXRlcmFsID0gdGhpcy5fYWxpYXNlcy5nZXQoaWQpO1xuICAgIH0gZWxzZSBpZiAob3B0aW9ucy5zb3VyY2VQYXRoICYmIHRoaXMuX2FsaWFzZXNUb1JlbGF0aXZpemUuaGFzKGlkKSkge1xuICAgICAgbGl0ZXJhbCA9IE1vZHVsZU1hcFV0aWxzLnJlbGF0aXZpemVGb3JSZXF1aXJlKFxuICAgICAgICBvcHRpb25zLnNvdXJjZVBhdGgsXG4gICAgICAgIHRoaXMuX2FsaWFzZXNUb1JlbGF0aXZpemUuZ2V0KGlkKVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgdGhpcy5fZGVmYXVsdHMuaGFzKGlkKSAmJlxuICAgICAgdGhpcy5fZGVmYXVsdHMuZ2V0KGlkKS5zaXplID09PSAxXG4gICAgKSB7XG4gICAgICAvLyBUT0RPOiBXaGF0J3MgdGhlIGJlc3Qgd2F5IHRvIGdldCB0aGUgc2luZ2xlIHRoaW5nIG91dCBvZiBhIG9uZSBlbGVtZW50XG4gICAgICAvLyBTZXQ/XG4gICAgICBmb3IgKHRtcCBvZiB0aGlzLl9kZWZhdWx0cy5nZXQoaWQpKSB7XG4gICAgICAgIGxpdGVyYWwgPSB0bXA7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoXG4gICAgICBvcHRpb25zLnNvdXJjZVBhdGggJiZcbiAgICAgIHRoaXMuX2RlZmF1bHRzVG9SZWxhdGl2aXplLmhhcyhpZCkgJiZcbiAgICAgIHRoaXMuX2RlZmF1bHRzVG9SZWxhdGl2aXplLmdldChpZCkuc2l6ZSA9PT0gMVxuICAgICkge1xuICAgICAgY29uc3Qgbm9uTnVsbFNvdXJjZVBhdGggPSBvcHRpb25zLnNvdXJjZVBhdGg7XG4gICAgICAvLyBUT0RPOiBXaGF0J3MgdGhlIGJlc3Qgd2F5IHRvIGdldCB0aGUgc2luZ2xlIHRoaW5nIG91dCBvZiBhIG9uZSBlbGVtZW50XG4gICAgICAvLyBTZXQ/XG4gICAgICBmb3IgKGNvbnN0IGZpbGVQYXRoIG9mIHRoaXMuX2RlZmF1bHRzVG9SZWxhdGl2aXplLmdldChpZCkpIHtcbiAgICAgICAgbGl0ZXJhbCA9IE1vZHVsZU1hcFV0aWxzLnJlbGF0aXZpemVGb3JSZXF1aXJlKFxuICAgICAgICAgIG5vbk51bGxTb3VyY2VQYXRoLFxuICAgICAgICAgIGZpbGVQYXRoXG4gICAgICAgICk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAob3B0aW9ucy5qc3hJZGVudGlmaWVyKSB7XG4gICAgICAvLyBUT0RPOiBNYWtlIHRoaXMgY29uZmlndXJhYmxlIHNvIHRoYXQgdGhlIHN1ZmZpeCBmb3IgSlNYIGNhbiBiZSBjaGFuZ2VkLlxuICAgICAgbGl0ZXJhbCA9IGlkICsgJy5yZWFjdCc7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRPRE86IE1ha2UgdGhpcyBjb25maWd1cmFibGUgc28gdGhhdCBpdCdzIHBvc3NpYmxlIHRvIG9ubHkgYWRkIGtub3duXG4gICAgICAvLyByZXF1aXJlcyBhbmQgaWdub3JlIHVua25vd24gbW9kdWxlcy5cbiAgICAgIGxpdGVyYWwgPSBpZDtcbiAgICB9XG5cbiAgICAvLyBDcmVhdGUgY29tbW9uIG5vZGVzIGZvciBwcmludGluZy5cbiAgICBjb25zdCBpZE5vZGUgPSBqc2NzLmlkZW50aWZpZXIoaWQpO1xuICAgIGNvbnN0IGxpdGVyYWxOb2RlID0ganNjcy5saXRlcmFsKGxpdGVyYWwpO1xuXG4gICAgLy8gVE9ETzogU3VwcG9ydCBleHBvcnRzIGFuZCBkZXN0cnVjdHVyaW5nLlxuICAgIGNvbnN0IGRlc3RydWN0dXJlID0gZmFsc2U7XG5cbiAgICBpZiAoZGVzdHJ1Y3R1cmUgJiYgb3B0aW9ucy50eXBlSW1wb3J0KSB7XG4gICAgICAvLyBpbXBvcnQgdHlwZSB7Zm9vfSBmcm9tICdmb28nO1xuICAgICAgdG1wID0gc3RhdGVtZW50YGltcG9ydCB0eXBlIHtffSBmcm9tICdfJ2A7XG4gICAgICB0bXAuc3BlY2lmaWVyc1swXS5pbXBvcnRlZCA9IGlkTm9kZTtcbiAgICAgIHRtcC5zcGVjaWZpZXJzWzBdLmxvY2FsID0gaWROb2RlO1xuICAgICAgdG1wLnNvdXJjZSA9IGxpdGVyYWxOb2RlO1xuICAgICAgcmV0dXJuIHRtcDtcbiAgICB9IGVsc2UgaWYgKCFkZXN0cnVjdHVyZSAmJiBvcHRpb25zLnR5cGVJbXBvcnQpIHtcbiAgICAgIC8vIGltcG9ydCB0eXBlIGZvbyBmcm9tICdmb28nO1xuICAgICAgdG1wID0gc3RhdGVtZW50YGltcG9ydCB0eXBlIF8gZnJvbSAnXydgO1xuICAgICAgdG1wLnNwZWNpZmllcnNbMF0uaWQgPSBpZE5vZGU7XG4gICAgICB0bXAuc3BlY2lmaWVyc1swXS5sb2NhbCA9IGlkTm9kZTtcbiAgICAgIHRtcC5zb3VyY2UgPSBsaXRlcmFsTm9kZTtcbiAgICAgIHJldHVybiB0bXA7XG4gICAgfSBlbHNlIGlmIChkZXN0cnVjdHVyZSAmJiAhb3B0aW9ucy50eXBlSW1wb3J0KSB7XG4gICAgICAvLyB2YXIge2Zvb30gPSByZXF1aXJlKCdmb28nKTtcbiAgICAgIGNvbnN0IHByb3BlcnR5ID0ganNjcy5wcm9wZXJ0eSgnaW5pdCcsIGlkTm9kZSwgaWROb2RlKTtcbiAgICAgIHByb3BlcnR5LnNob3J0aGFuZCA9IHRydWU7XG4gICAgICByZXR1cm4ganNjcy52YXJpYWJsZURlY2xhcmF0aW9uKFxuICAgICAgICAnY29uc3QnLFxuICAgICAgICBbanNjcy52YXJpYWJsZURlY2xhcmF0b3IoXG4gICAgICAgICAgb25lTGluZU9iamVjdFBhdHRlcm4oanNjcy5vYmplY3RQYXR0ZXJuKFtwcm9wZXJ0eV0pKSxcbiAgICAgICAgICBqc2NzLmNhbGxFeHByZXNzaW9uKFxuICAgICAgICAgICAganNjcy5pZGVudGlmaWVyKCdyZXF1aXJlJyksXG4gICAgICAgICAgICBbbGl0ZXJhbE5vZGVdXG4gICAgICAgICAgKVxuICAgICAgICApXVxuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKCFkZXN0cnVjdHVyZSAmJiAhb3B0aW9ucy50eXBlSW1wb3J0KSB7XG4gICAgICAvLyB2YXIgZm9vID0gcmVxdWlyZSgnZm9vJyk7XG4gICAgICByZXR1cm4ganNjcy52YXJpYWJsZURlY2xhcmF0aW9uKFxuICAgICAgICAnY29uc3QnLFxuICAgICAgICBbanNjcy52YXJpYWJsZURlY2xhcmF0b3IoXG4gICAgICAgICAgaWROb2RlLFxuICAgICAgICAgIGpzY3MuY2FsbEV4cHJlc3Npb24oXG4gICAgICAgICAgICBqc2NzLmlkZW50aWZpZXIoJ3JlcXVpcmUnKSxcbiAgICAgICAgICAgIFtsaXRlcmFsTm9kZV1cbiAgICAgICAgICApXG4gICAgICAgICldXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENhbid0IGhhbmRsZSB0aGlzIHR5cGUgb2YgcmVxdWlyZSB5ZXQuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBnZXRCdWlsdElucygpOiBTZXQ8SWRlbnRpZmllcj4ge1xuICAgIHJldHVybiB0aGlzLl9idWlsdElucztcbiAgfVxuXG4gIGdldEJ1aWx0SW5UeXBlcygpOiBTZXQ8SWRlbnRpZmllcj4ge1xuICAgIHJldHVybiB0aGlzLl9idWlsdEluVHlwZXM7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNb2R1bGVNYXA7XG4iXX0=
