
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var jscs = require('jscodeshift');

/**
 * This will get a list of all types that are not from a declaration.
 *
 * NOTE: this can get types that are declared, if you want access to
 * types that are used but undeclared see getUndeclaredTypes
 */
function getNonDeclarationTypes(root) {
  var ids = new Set();

  // Pull out the logic to handle a generic type annotation, we have to iterate
  // down the qualified types to handle things like: `<Immutable.List<Foo>>`
  function handleGenericType(node) {
    if (jscs.Identifier.check(node.id)) {
      ids.add(node.id.name);
    }
    if (jscs.QualifiedTypeIdentifier.check(node.id)) {
      var currPos = node.id;
      while (currPos && !jscs.Identifier.check(currPos)) {
        currPos = currPos.qualification;
      }
      if (jscs.Identifier.check(currPos)) {
        ids.add(currPos.name);
      }
    }
  }

  // Ideally this would be the only find in here, but it's not because of a
  // jscodeshift bug, so we have to manually search for a specific kind of
  // GenericTypeAnnotations on class super types
  root.find(jscs.GenericTypeAnnotation).forEach(function (path) {
    return handleGenericType(path.node);
  });

  // TODO: Delete this after https://github.com/facebook/jscodeshift/issues/34
  root.find(jscs.ClassDeclaration).filter(function (path) {
    return path.node.superTypeParameters && Array.isArray(path.node.superTypeParameters.params);
  }).forEach(function (path) {
    jscs(path.node.superTypeParameters).find(jscs.GenericTypeAnnotation).forEach(function (subPath) {
      return handleGenericType(subPath.node);
    });
  });

  return ids;
}

module.exports = getNonDeclarationTypes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBwZmw1Mm5wdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWZvcm1hdC1qcy1iYXNlL2xpYi91dGlscy9nZXROb25EZWNsYXJhdGlvblR5cGVzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7OztBQWFaLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQzs7Ozs7Ozs7QUFRcEMsU0FBUyxzQkFBc0IsQ0FBQyxJQUFnQixFQUFlO0FBQzdELE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7Ozs7QUFJdEIsV0FBUyxpQkFBaUIsQ0FBQyxJQUFVLEVBQVE7QUFDM0MsUUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUU7QUFDbEMsU0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3ZCO0FBQ0QsUUFBSSxJQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRTtBQUMvQyxVQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDO0FBQ3RCLGFBQU8sT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDakQsZUFBTyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUM7T0FDakM7QUFDRCxVQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFO0FBQ2xDLFdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO09BQ3ZCO0tBQ0Y7R0FDRjs7Ozs7QUFLRCxNQUFJLENBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUNoQyxPQUFPLENBQUMsVUFBQSxJQUFJO1dBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztHQUFBLENBQUMsQ0FBQzs7O0FBR2pELE1BQUksQ0FDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQzNCLE1BQU0sQ0FBQyxVQUFBLElBQUk7V0FDVixJQUFJLENBQUMsSUFBSSxDQUFDLG1CQUFtQixJQUM3QixLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDO0dBQ3BELENBQUMsQ0FDRCxPQUFPLENBQUMsVUFBQSxJQUFJLEVBQUk7QUFDZixRQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUNoQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQ2hDLE9BQU8sQ0FBQyxVQUFBLE9BQU87YUFBSSxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO0tBQUEsQ0FBQyxDQUFDO0dBQ3hELENBQUMsQ0FBQzs7QUFFTCxTQUFPLEdBQUcsQ0FBQztDQUNaOztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUcsc0JBQXNCLENBQUMiLCJmaWxlIjoiL3Zhci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcHBmbDUybnB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtZm9ybWF0LWpzLWJhc2UvbGliL3V0aWxzL2dldE5vbkRlY2xhcmF0aW9uVHlwZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5pbXBvcnQgdHlwZSB7Q29sbGVjdGlvbiwgTm9kZX0gZnJvbSAnLi4vdHlwZXMvYXN0JztcblxuY29uc3QganNjcyA9IHJlcXVpcmUoJ2pzY29kZXNoaWZ0Jyk7XG5cbi8qKlxuICogVGhpcyB3aWxsIGdldCBhIGxpc3Qgb2YgYWxsIHR5cGVzIHRoYXQgYXJlIG5vdCBmcm9tIGEgZGVjbGFyYXRpb24uXG4gKlxuICogTk9URTogdGhpcyBjYW4gZ2V0IHR5cGVzIHRoYXQgYXJlIGRlY2xhcmVkLCBpZiB5b3Ugd2FudCBhY2Nlc3MgdG9cbiAqIHR5cGVzIHRoYXQgYXJlIHVzZWQgYnV0IHVuZGVjbGFyZWQgc2VlIGdldFVuZGVjbGFyZWRUeXBlc1xuICovXG5mdW5jdGlvbiBnZXROb25EZWNsYXJhdGlvblR5cGVzKHJvb3Q6IENvbGxlY3Rpb24pOiBTZXQ8c3RyaW5nPiB7XG4gIGNvbnN0IGlkcyA9IG5ldyBTZXQoKTtcblxuICAvLyBQdWxsIG91dCB0aGUgbG9naWMgdG8gaGFuZGxlIGEgZ2VuZXJpYyB0eXBlIGFubm90YXRpb24sIHdlIGhhdmUgdG8gaXRlcmF0ZVxuICAvLyBkb3duIHRoZSBxdWFsaWZpZWQgdHlwZXMgdG8gaGFuZGxlIHRoaW5ncyBsaWtlOiBgPEltbXV0YWJsZS5MaXN0PEZvbz4+YFxuICBmdW5jdGlvbiBoYW5kbGVHZW5lcmljVHlwZShub2RlOiBOb2RlKTogdm9pZCB7XG4gICAgaWYgKGpzY3MuSWRlbnRpZmllci5jaGVjayhub2RlLmlkKSkge1xuICAgICAgaWRzLmFkZChub2RlLmlkLm5hbWUpO1xuICAgIH1cbiAgICBpZiAoanNjcy5RdWFsaWZpZWRUeXBlSWRlbnRpZmllci5jaGVjayhub2RlLmlkKSkge1xuICAgICAgbGV0IGN1cnJQb3MgPSBub2RlLmlkO1xuICAgICAgd2hpbGUgKGN1cnJQb3MgJiYgIWpzY3MuSWRlbnRpZmllci5jaGVjayhjdXJyUG9zKSkge1xuICAgICAgICBjdXJyUG9zID0gY3VyclBvcy5xdWFsaWZpY2F0aW9uO1xuICAgICAgfVxuICAgICAgaWYgKGpzY3MuSWRlbnRpZmllci5jaGVjayhjdXJyUG9zKSkge1xuICAgICAgICBpZHMuYWRkKGN1cnJQb3MubmFtZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gSWRlYWxseSB0aGlzIHdvdWxkIGJlIHRoZSBvbmx5IGZpbmQgaW4gaGVyZSwgYnV0IGl0J3Mgbm90IGJlY2F1c2Ugb2YgYVxuICAvLyBqc2NvZGVzaGlmdCBidWcsIHNvIHdlIGhhdmUgdG8gbWFudWFsbHkgc2VhcmNoIGZvciBhIHNwZWNpZmljIGtpbmQgb2ZcbiAgLy8gR2VuZXJpY1R5cGVBbm5vdGF0aW9ucyBvbiBjbGFzcyBzdXBlciB0eXBlc1xuICByb290XG4gICAgLmZpbmQoanNjcy5HZW5lcmljVHlwZUFubm90YXRpb24pXG4gICAgLmZvckVhY2gocGF0aCA9PiBoYW5kbGVHZW5lcmljVHlwZShwYXRoLm5vZGUpKTtcblxuICAvLyBUT0RPOiBEZWxldGUgdGhpcyBhZnRlciBodHRwczovL2dpdGh1Yi5jb20vZmFjZWJvb2svanNjb2Rlc2hpZnQvaXNzdWVzLzM0XG4gIHJvb3RcbiAgICAuZmluZChqc2NzLkNsYXNzRGVjbGFyYXRpb24pXG4gICAgLmZpbHRlcihwYXRoID0+IChcbiAgICAgIHBhdGgubm9kZS5zdXBlclR5cGVQYXJhbWV0ZXJzICYmXG4gICAgICBBcnJheS5pc0FycmF5KHBhdGgubm9kZS5zdXBlclR5cGVQYXJhbWV0ZXJzLnBhcmFtcylcbiAgICApKVxuICAgIC5mb3JFYWNoKHBhdGggPT4ge1xuICAgICAganNjcyhwYXRoLm5vZGUuc3VwZXJUeXBlUGFyYW1ldGVycylcbiAgICAgICAgLmZpbmQoanNjcy5HZW5lcmljVHlwZUFubm90YXRpb24pXG4gICAgICAgIC5mb3JFYWNoKHN1YlBhdGggPT4gaGFuZGxlR2VuZXJpY1R5cGUoc3ViUGF0aC5ub2RlKSk7XG4gICAgfSk7XG5cbiAgcmV0dXJuIGlkcztcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBnZXROb25EZWNsYXJhdGlvblR5cGVzO1xuIl19
